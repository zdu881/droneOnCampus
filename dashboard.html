<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campus Drone Management System - Digital Twin</title>
    <link rel="stylesheet" href="dashboard-styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- 主应用容器 -->
    <div class="app-container">
      <!-- 顶部工具栏 -->
      <header class="app-header">
        <div class="header-left">
          <div class="app-logo">
            <i class="fas fa-drone"></i>
            <span class="app-title">Campus Drone Digital Twin</span>
          </div>
          <div class="connection-status">
            <div class="status-indicator" id="connection-indicator">
              <div class="status-dot" data-status="connected"></div>
              <span>UE Connected</span>
            </div>
          </div>
        </div>

        <div class="header-center">
          <!-- 场景切换 -->
          <div class="scenario-switcher">
            <button class="scenario-btn active" data-scenario="drone">
              <i class="fas fa-drone"></i>
              <span>无人机配送</span>
            </button>
            <button class="scenario-btn" data-scenario="vehicle">
              <i class="fas fa-car"></i>
              <span>自动驾驶</span>
            </button>
          </div>
        </div>

        <div class="header-right">
          <div class="system-time" id="system-time">--:--:--</div>
          <div class="simulation-controls">
            <button
              class="tool-btn"
              id="attach-worker-btn"
              title="连接工作节点"
            >
              <i class="fas fa-plug"></i>
            </button>
            <button class="tool-btn" id="start-simulation-btn" title="开始仿真">
              <i class="fas fa-play"></i>
            </button>
            <button class="tool-btn" id="pause-simulation-btn" title="暂停仿真">
              <i class="fas fa-pause"></i>
            </button>
            <button class="tool-btn" id="stop-simulation-btn" title="停止仿真">
              <i class="fas fa-stop"></i>
            </button>
          </div>
        </div>
      </header>

      <!-- 主内容区域 -->
      <div class="app-main">
        <!-- 侧边栏标签 -->
        <div class="sidebar-tabs">
          <button class="tab-btn active" data-tab="viewport">
            <i class="fas fa-eye"></i>
            <span>视口</span>
          </button>
          <button class="tab-btn" data-tab="configuration">
            <i class="fas fa-cog"></i>
            <span>配置</span>
          </button>
          <button class="tab-btn" data-tab="console">
            <i class="fas fa-terminal"></i>
            <span>控制台</span>
          </button>
          <button class="tab-btn" data-tab="assets">
            <i class="fas fa-box"></i>
            <span>资源</span>
          </button>
          <button class="tab-btn" data-tab="telemetry">
            <i class="fas fa-chart-line"></i>
            <span>遥测</span>
          </button>
          <button class="tab-btn" data-tab="rayCluster">
            <i class="fas fa-server"></i>
            <span>Ray集群</span>
          </button>
        </div>

        <!-- 主内容面板 -->
        <div class="main-content-panel">
          <!-- 中央视口区域 -->
          <div class="main-content active" id="viewport-content-page">
            <!-- 视频流/3D视口 -->
            <div class="viewport-content">
              <video
                id="main-viewport"
                autoplay
                muted
                playsinline
                style="display: none"
              ></video>
              <iframe
                id="pixel-streaming-viewport"
                src="http://10.30.2.11:80"
                style="width: 100%; height: 100%; border: none"
              ></iframe>

              <!-- 视口工具栏 -->
              <div class="viewport-toolbar">
                <div class="view-controls">
                  <label>视角:</label>
                  <select id="view-type-select">
                    <option value="top">俯视图</option>
                    <option value="perspective">透视图</option>
                    <option value="follow">跟随视角</option>
                  </select>
                </div>
                <div class="viewport-settings">
                  <button class="viewport-btn" id="toggle-grid">
                    <i class="fas fa-th"></i>
                  </button>
                  <button class="viewport-btn" id="toggle-compass">
                    <i class="fas fa-compass"></i>
                  </button>
                  <button class="viewport-btn" id="fullscreen-btn">
                    <i class="fas fa-expand"></i>
                  </button>
                </div>
              </div>

              <!-- 实时数据覆盖层 -->
              <div class="data-overlays">
                <!-- 左上角 - 无人机遥测 -->
                <div class="data-panel drone-telemetry">
                  <div class="panel-header">
                    <i class="fas fa-drone"></i>
                    <span>无人机遥测</span>
                  </div>
                  <div class="data-grid">
                    <div class="data-item">
                      <span class="label">位置 X:</span>
                      <span class="value" id="drone-x">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">位置 Y:</span>
                      <span class="value" id="drone-y">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">高度:</span>
                      <span class="value" id="drone-z">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">电池:</span>
                      <span class="value" id="drone-battery">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">速度:</span>
                      <span class="value" id="drone-speed">--</span>
                    </div>
                  </div>
                </div>

                <!-- 右上角 - 任务状态 -->
                <div class="data-panel mission-status">
                  <div class="panel-header">
                    <i class="fas fa-tasks"></i>
                    <span>任务状态</span>
                  </div>
                  <div class="data-grid">
                    <div class="data-item">
                      <span class="label">状态:</span>
                      <span class="value" id="mission-status">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">目标:</span>
                      <span class="value" id="mission-target">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">距离:</span>
                      <span class="value" id="target-distance">--</span>
                    </div>
                    <div class="data-item">
                      <span class="label">风速:</span>
                      <span class="value" id="wind-speed">--</span>
                    </div>
                  </div>
                </div>

                <!-- 底部中央 - 网络质量 -->
                <div class="data-panel network-quality">
                  <div class="panel-header">
                    <i class="fas fa-wifi"></i>
                    <span>网络质量</span>
                  </div>
                  <div class="quality-meters">
                    <div class="meter">
                      <span class="meter-label">带宽</span>
                      <div class="meter-bar">
                        <div class="meter-fill" id="bandwidth-meter"></div>
                      </div>
                      <span class="meter-value" id="bandwidth-value"
                        >-- Mbps</span
                      >
                    </div>
                    <div class="meter">
                      <span class="meter-label">延迟</span>
                      <div class="meter-bar">
                        <div class="meter-fill" id="latency-meter"></div>
                      </div>
                      <span class="meter-value" id="latency-value">-- ms</span>
                    </div>
                    <div class="meter">
                      <span class="meter-label">信号</span>
                      <div class="meter-bar">
                        <div class="meter-fill" id="signal-meter"></div>
                      </div>
                      <span class="meter-value" id="signal-value">--</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 配置页面 -->
          <div class="main-content" id="configuration-content-page">
            <div class="page-header">
              <h1>系统配置</h1>
              <p>管理系统连接和全局参数</p>
            </div>
            <div class="page-content">
              <div class="config-section">
                <h4>数据库配置</h4>
                <div class="config-grid">
                  <div class="config-item">
                    <label>DB主机:</label>
                    <input
                      type="text"
                      id="db-host"
                      value="10.30.2.11"
                      placeholder="数据库主机地址"
                    />
                  </div>
                  <div class="config-item">
                    <label>DB端口:</label>
                    <input
                      type="number"
                      id="db-port"
                      value="9000"
                      placeholder="9000"
                    />
                  </div>
                  <div class="config-item">
                    <label>数据库名:</label>
                    <input
                      type="text"
                      id="db-name"
                      placeholder="drone_telemetry"
                    />
                  </div>
                  <div class="config-item">
                    <button class="action-btn connect-btn" id="connect-db-btn">
                      <i class="fas fa-plug"></i>
                      连接数据库
                    </button>
                  </div>
                </div>
              </div>
              <div class="config-section">
                <h4>UE连接配置</h4>
                <div class="config-grid">
                  <div class="config-item">
                    <label>流服务器:</label>
                    <input
                      type="text"
                      id="streaming-url"
                      value="http://10.30.2.11:80"
                      placeholder="流地址"
                    />
                  </div>
                  <div class="config-item">
                    <label>API端点:</label>
                    <input
                      type="text"
                      id="api-endpoint"
                      value="http://10.30.2.11:7777"
                      placeholder="API地址"
                    />
                  </div>
                  <div class="config-item">
                    <button class="action-btn primary-btn" id="connect-ue-btn">
                      <i class="fas fa-link"></i>
                      连接UE
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 控制台页面 -->
          <div class="main-content" id="console-content-page">
            <div class="page-header">
              <h1>系统控制台</h1>
              <p>查看实时系统日志和事件</p>
            </div>
            <div class="page-content">
              <div class="console-section full-height">
                <div class="console-header">
                  <h4>实时日志</h4>
                  <button class="clear-btn" id="clear-console">
                    <i class="fas fa-trash"></i>
                    清空
                  </button>
                </div>
                <div class="console-output" id="console-output">
                  <!-- 控制台输出 -->
                </div>
              </div>
            </div>
          </div>

          <!-- 占位符页面 -->
          <div class="main-content" id="assets-content-page">
            <div class="placeholder-page">
              <i class="fas fa-box-open"></i>
              <h1>资源管理</h1>
              <p>此功能正在开发中</p>
            </div>
          </div>
          <div class="main-content" id="telemetry-content-page">
            <div class="placeholder-page">
              <i class="fas fa-chart-pie"></i>
              <h1>遥测数据分析</h1>
              <p>此功能正在开发中</p>
            </div>
          </div>

          <!-- Ray集群监控页面 -->
          <div class="main-content" id="rayCluster-content-page">
            <div class="ray-cluster-container">
              <!-- 集群状态头部 -->
              <div class="cluster-header">
                <div class="cluster-title">
                  <i class="fas fa-server"></i>
                  <h2>CastRay 集群监控系统</h2>
                </div>
                <div class="cluster-status">
                  <div class="cluster-status-indicator disconnected">
                    <div class="status-dot"></div>
                    <span>未连接</span>
                  </div>
                  <div class="connection-info">
                    <small id="cluster-data-source">正在连接 CastRay 后端...</small>
                  </div>
                </div>
              </div>

              <!-- 控制面板 -->
              <div class="cluster-controls">
                <div class="control-group">
                  <button id="refresh-cluster-btn" class="cluster-btn primary">
                    <i class="fas fa-sync-alt"></i>
                    刷新数据
                  </button>
                  <button id="restart-cluster-btn" class="cluster-btn">
                    <i class="fas fa-redo"></i>
                    重启集群
                  </button>
                  <button id="stop-cluster-btn" class="cluster-btn danger">
                    <i class="fas fa-stop"></i>
                    停止集群
                  </button>
                  <button id="cluster-file-transfer-btn" class="cluster-btn">
                    <i class="fas fa-upload"></i>
                    文件传输
                  </button>
                </div>
              </div>

              <!-- 集群统计面板 -->
              <div class="cluster-metrics">
                <div class="metric-card" data-metric="total-nodes">
                  <div class="metric-icon"><i class="fas fa-server"></i></div>
                  <div class="metric-info">
                    <div class="metric-title">总节点数</div>
                    <div class="metric-value" id="total-nodes-value">0</div>
                  </div>
                </div>
                <div class="metric-card" data-metric="alive-nodes">
                  <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
                  <div class="metric-info">
                    <div class="metric-title">活跃节点</div>
                    <div class="metric-value" id="alive-nodes-value">0</div>
                  </div>
                </div>
                <div class="metric-card" data-metric="cpu-usage">
                  <div class="metric-icon"><i class="fas fa-microchip"></i></div>
                  <div class="metric-info">
                    <div class="metric-title">CPU 使用</div>
                    <div class="metric-value" id="cpu-usage-value">0 / 0</div>
                    <div class="metric-subtitle" id="cpu-usage-percent">0%</div>
                  </div>
                </div>
                <div class="metric-card" data-metric="memory-usage">
                  <div class="metric-icon"><i class="fas fa-memory"></i></div>
                  <div class="metric-info">
                    <div class="metric-title">内存使用</div>
                    <div class="metric-value" id="memory-usage-value">0 / 0 GB</div>
                    <div class="metric-subtitle" id="memory-usage-percent">0%</div>
                  </div>
                </div>
                <div class="metric-card" data-metric="gpu-usage">
                  <div class="metric-icon"><i class="fas fa-video"></i></div>
                  <div class="metric-info">
                    <div class="metric-title">GPU 资源</div>
                    <div class="metric-value" id="gpu-usage-value">0 个</div>
                  </div>
                </div>
              </div>

              <!-- 节点列表 -->
              <div class="cluster-nodes-panel">
                <div class="nodes-header">
                  <h3><i class="fas fa-network-wired"></i> 集群节点 <span class="node-count-badge" id="node-count-badge">0</span></h3>
                  <div class="nodes-controls">
                    <label>
                      <i class="fas fa-filter"></i>
                      <select id="nodes-filter">
                        <option value="all">所有节点</option>
                        <option value="active">活跃节点</option>
                        <option value="inactive">非活跃节点</option>
                        <option value="gpu">GPU 节点</option>
                        <option value="wired">有线连接</option>
                        <option value="wireless">无线连接</option>
                      </select>
                    </label>
                    <label>
                      <i class="fas fa-sort"></i>
                      <select id="nodes-sort">
                        <option value="name">按名称</option>
                        <option value="cpu">按CPU使用率</option>
                        <option value="memory">按内存使用率</option>
                        <option value="gpu">按GPU使用率</option>
                      </select>
                    </label>
                  </div>
                </div>
                <div class="nodes-container" id="cluster-nodes-grid">
                  <!-- 节点卡片将由JavaScript动态生成 -->
                  <div class="empty-state" id="cluster-empty-state">
                    <div class="empty-icon"><i class="fas fa-plug"></i></div>
                    <h3>未连接到 CastRay 后端</h3>
                    <p>请确保 CastRay 服务正在运行于 <code>http://10.30.2.11:8000</code></p>
                    <div class="empty-actions">
                      <button onclick="window.dashboardManager && window.dashboardManager.rayClusterManager ? window.dashboardManager.rayClusterManager.fetchClusterData() : console.log('Ray cluster manager not available')" class="retry-btn">
                        <i class="fas fa-sync-alt"></i> 重试连接
                      </button>
                      <a href="http://10.30.2.11:8000/api/status" target="_blank" class="check-backend-btn">
                        <i class="fas fa-external-link-alt"></i> 检查后端服务
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 文件传输对话框 -->
              <div class="modal" id="file-transfer-modal" style="display: none;">
                <div class="modal-content">
                  <div class="modal-header">
                    <h3><i class="fas fa-exchange-alt"></i> 节点间文件传输</h3>
                    <button class="modal-close" onclick="document.getElementById('file-transfer-modal').style.display='none'">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div class="modal-body">
                    <form id="file-transfer-form">
                      <div class="form-group">
                        <label for="source-node">源节点：</label>
                        <select id="source-node" required>
                          <option value="">选择源节点...</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="target-node">目标节点：</label>
                        <select id="target-node" required>
                          <option value="">选择目标节点...</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="file-path">文件路径：</label>
                        <input type="text" id="file-path" placeholder="/path/to/file.txt" required />
                      </div>
                      <div class="form-group">
                        <label for="transfer-mode">传输模式：</label>
                        <select id="transfer-mode">
                          <option value="auto">自动选择最优路径</option>
                          <option value="direct">直连传输</option>
                          <option value="relay">中继传输</option>
                        </select>
                      </div>
                      <div class="form-actions">
                        <button type="submit" class="btn-primary">
                          <i class="fas fa-paper-plane"></i> 开始传输
                        </button>
                        <button type="button" class="btn-secondary" onclick="document.getElementById('file-transfer-modal').style.display='none'">
                          取消
                        </button>
                      </div>
                    </form>
                    <div id="transfer-status" class="transfer-status" style="display: none;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 右侧属性面板 -->
        <div class="properties-panel">
          <div class="properties-header">
            <h3>属性与控制</h3>
            <button class="collapse-btn" id="collapse-properties">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="panel-content-wrapper">
            <!-- 场景树 -->
            <div class="scene-tree">
              <div class="tree-header">
                <i class="fas fa-sitemap"></i>
                <span>场景对象</span>
              </div>
              <div class="tree-content" id="scene-tree-content">
                <!-- 场景对象将由JavaScript动态生成 -->
              </div>
            </div>

            <!-- 对象属性与控制 -->
            <div class="object-properties">
              <div class="properties-header-alt">
                <i class="fas fa-sliders-h"></i>
                <span>属性与控制</span>
              </div>
              <div class="properties-content" id="properties-content">
                <!-- 默认显示 -->
                <div class="control-section active" id="default-controls">
                  <p class="placeholder-text">
                    在场景对象中选择一个项目以查看其属性和可用操作。
                  </p>
                </div>

                <!-- 配送控制 -->
                <div class="control-section" id="delivery-controls">
                  <h4>配送任务</h4>
                  <div class="delivery-routes">
                    <div class="route-item">
                      <button
                        class="delivery-btn"
                        data-from="Campus_Gate"
                        data-to="Library"
                      >
                        <i class="fas fa-route"></i>
                        <div class="route-info">
                          <span class="route-name">校门 → 图书馆</span>
                          <span class="route-distance">~850m</span>
                        </div>
                      </button>
                    </div>
                    <div class="route-item">
                      <button
                        class="delivery-btn"
                        data-from="Library"
                        data-to="Cafeteria"
                      >
                        <i class="fas fa-route"></i>
                        <div class="route-info">
                          <span class="route-name">图书馆 → 食堂</span>
                          <span class="route-distance">~620m</span>
                        </div>
                      </button>
                    </div>
                    <div class="route-item">
                      <button
                        class="delivery-btn"
                        data-from="Cafeteria"
                        data-to="Dormitory"
                      >
                        <i class="fas fa-route"></i>
                        <div class="route-info">
                          <span class="route-name">食堂 → 宿舍</span>
                          <span class="route-distance">~440m</span>
                        </div>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- 摄像头控制 -->
                <div class="control-section" id="camera-controls">
                  <h4>摄像头预设</h4>
                  <div class="camera-presets">
                    <button class="camera-btn" data-view="overview">
                      <i class="fas fa-eye"></i>
                      <span>全景视角</span>
                    </button>
                    <button class="camera-btn" data-view="tracking">
                      <i class="fas fa-crosshairs"></i>
                      <span>跟踪视角</span>
                    </button>
                    <button class="camera-btn" data-view="close-up">
                      <i class="fas fa-search-plus"></i>
                      <span>近距离视角</span>
                    </button>
                    <button class="camera-btn" data-view="fpv">
                      <i class="fas fa-eye-slash"></i>
                      <span>第一人称视角</span>
                    </button>
                  </div>
                </div>

                <!-- 基站管理 -->
                <div class="control-section" id="station-controls">
                  <h4>基站部署</h4>
                  <div class="station-controls">
                    <div class="station-type-selector">
                      <label>基站类型:</label>
                      <select id="station-type">
                        <option value="charging">🔋 充电基站</option>
                        <option value="communication">📡 通信基站</option>
                        <option value="weather">🌡️ 气象站</option>
                        <option value="security">🛡️ 安全基站</option>
                      </select>
                    </div>
                    <div class="position-inputs">
                      <input type="number" id="station-x" placeholder="X坐标" />
                      <input type="number" id="station-y" placeholder="Y坐标" />
                      <input type="number" id="station-z" placeholder="Z坐标" />
                      <input
                        type="text"
                        id="station-name"
                        placeholder="基站名称"
                      />
                    </div>
                    <button
                      class="action-btn primary-btn"
                      id="deploy-station-btn"
                    >
                      <i class="fas fa-plus"></i>
                      部署基站
                    </button>
                  </div>
                  <div class="stations-list" id="stations-list">
                    <!-- 基站列表将动态生成 -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript 模块 -->
    <script src="api-manager.js"></script>
    <script src="pixel-streaming.js"></script>
    <script src="ray-cluster-manager.js"></script>
    <script src="dashboard-manager.js"></script>
  </body>
</html>
