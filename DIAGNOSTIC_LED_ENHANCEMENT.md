# 诊断模块 LED 指示灯增强功能

## 概述

这次更新为 droneOnCampus 诊断模块实现了**增强的 LED 三色指示灯状态管理**和**详细的云处理特征日志**。系统现在可以更清晰地展示处理流程的各个阶段，包括本地处理、云端处理以及错误告警。

---

## 主要功能

### 1. 扩展的 LED 指示灯状态

指示灯现在支持以下状态转换：

```
┌─────────────────────────────────────────────────────────────┐
│                  LED 指示灯状态转换流程                      │
├─────────────────────────────────────────────────────────────┤
│  绿 (待命/初始化)
│  ├→ 黄 (本地处理)  - Local inference running
│  │  ├→ 黄 (云端处理) - Low confidence samples detected
│  │  │  ├→ 绿 (完成)  - Successfully processed
│  │  │  └→ 红 (错误)  - Cloud service error
│  │  └→ 红 (错误)  - Local processing failed
│  └→ 红 (错误)   - Initialization failed
└─────────────────────────────────────────────────────────────┘
```

**状态详解：**

| 状态 | 颜色 | 含义 | 备注 |
|------|------|------|------|
| `initializing` | 🟢 绿 | 系统待命或初始化 | 准备开始检测 |
| `local_processing` | 🟡 黄 | 本地推理处理中 | 进行本地 AI 推理 |
| `cloud_processing` | 🟡 黄 | 云端处理中 | 检测到低置信度样本，上传至云端 |
| `completed` | 🟢 绿 | 处理完成 | 所有任务成功完成 |
| `error` | 🔴 红 | 发生错误 | 闪烁并记录详细错误信息 |

### 2. 详细的状态转换日志

每次状态转换都会自动记录：

```
[14:32:45] 指示灯已切换为: 绿色(正常) - 准备开始检测...
[14:32:46] 检测模式: 自动模式(实时数据)
[14:32:46] 目标节点: jet1
[14:32:46] 任务ID: a1b2c3d4
[14:32:46] 指示灯已切换为: 黄色(本地处理中) - 开始本地数据处理...
[14:32:48] 本地处理进度: 10%
[14:32:49] 本地处理进度: 25%
...
```

### 3. 云处理特征信息

当检测到需要云处理时，系统会记录：

```
[14:32:50] 检测到云处理请求: 低置信度样本=15
[14:32:50] 云端服务: 准备上传样本进行云端推理
[14:32:51] 指示灯已切换为: 黄色(云端处理中) - 云端处理中...
[14:32:52] 云端上传: 15 个样本
[14:32:55] 云端处理耗时: 3500ms
[14:32:55] 统计信息: 总样本=100, 高置信=85, 低置信=15
[14:32:55] 指示灯已切换为: 绿色(完成) - 检测成功完成
```

### 4. 红色告警和错误处理

当发生错误时，指示灯立即变为**红色并闪烁**，同时记录详细的错误信息：

```
[14:33:10] 检测失败: 云服务拒绝处理: 低置信度样本数量超过阈值
[14:33:10] 错误详情: 云端AI服务评估认为样本质量不符合处理标准(平均置信度 < 0.7)
[14:33:10] 失败阶段: cloud_inference
[14:33:10] 建议操作: 请重新采集更高质量的样本数据
```

---

## 代码实现细节

### 2.1 前端修改 (dashboard-manager.js)

#### 增强的 `setJetIndicators()` 函数

```javascript
setJetIndicators(colorOrState, additionalInfo = null) {
    // 支持状态名称和颜色名称
    const stateMapping = {
        'initializing': { color: 'green', label: '绿色(正常)', ueColor: 1 },
        'local_processing': { color: 'yellow', label: '黄色(本地处理中)', ueColor: 2 },
        'cloud_processing': { color: 'yellow', label: '黄色(云端处理中)', ueColor: 2 },
        'completed': { color: 'green', label: '绿色(完成)', ueColor: 1 },
        'error': { color: 'red', label: '红色(错误)', ueColor: 0 },
        // ... 向后兼容
    };
    // 功能:
    // 1. 更新前端 LED 指示灯
    // 2. 同步控制 UE 内的基站灯光
    // 3. 记录状态转换历史
    // 4. 自动生成带时间戳的日志
}
```

#### 修改的 `runDetectionTask()` 函数

```javascript
async runDetectionTask(mode) {
    // 新增功能:
    // 1. 初始化时切换到 'initializing' 状态
    // 2. 启动时切换到 'local_processing' 状态
    // 3. 记录检测模式和节点信息
    // 4. 错误时立即切换到 'error' 状态并记录
}
```

#### 增强的 `pollDetectionStatus()` 函数

```javascript
async pollDetectionStatus(taskId) {
    // 新增功能:
    // 1. 检测 API 响应中的 cloud_processing 标志
    // 2. 检测到云处理时自动切换状态并记录
    // 3. 记录进度变化日志
    // 4. 记录详细的错误信息和错误原因
    // 5. 超时处理和网络错误处理
}
```

#### 增强的 `showDetectionResults()` 函数

```javascript
showDetectionResults(status) {
    // 新增功能:
    // 1. 检查错误状态并立即切换到红色告警
    // 2. 记录详细的错误信息 (error_detail, failure_stage, suggested_action)
    // 3. 记录云处理特征 (cloud_processing_samples, cloud_upload_time_ms 等)
    // 4. 生成统计信息日志
    // 5. 根据成功/失败切换适当的指示灯状态
}
```

#### 新增的 `startDetectionErrorTest()` 函数

```javascript
startDetectionErrorTest(errorType) {
    // 启动特殊的错误测试模式
    // 参数: 'cloud_rejection', 'service_error', 'timeout', 'network_error'
    // 用于演示红色告警和错误处理流程
}
```

### 2.2 后端修改 (services/castray/main.py)

#### 增强的 `_run_detection_task()` 函数

```python
async def _run_detection_task(task_id, node_id, mode, data_source):
    """
    新增功能:
    1. 在结果中添加 cloud_processing 标志
    2. 记录低置信度样本数量
    3. 记录云上传耗时 (cloud_upload_time_ms)
    4. 记录云处理耗时 (cloud_processing_time_ms)
    5. 详细的错误信息记录
    
    结果示例:
    {
        "cloud_processing": True,
        "cloud_processing_samples": 15,
        "cloud_upload_time_ms": 1250,
        "cloud_processing_time_ms": 3500,
        ...
    }
    """
```

#### 新增的错误测试 API 端点

```python
@app.post("/api/station-maintenance/detect-error-test")
async def start_detection_error_test(request_data: dict):
    """
    启动特殊的错误测试模式，用于演示各种错误场景
    
    支持的错误类型:
    - 'cloud_rejection': 云服务拒绝 (低置信度超阈值)
    - 'service_error': 云服务内部错误
    - 'timeout': 云处理超时
    - 'network_error': 网络连接错误
    
    返回值包含详细的错误信息、失败阶段、建议操作等
    """
```

---

## 演示页面

创建了一个专门的**诊断模块演示页面** (`diagnostic-demo.html`)，包含：

### 功能特点

1. **实时 LED 指示灯显示**
   - 三个独立的基站 LED 指示灯
   - 实时颜色转换和状态显示
   - 闪烁效果显示错误状态

2. **四个预定义的测试场景**
   - ✓ **正常完成**: 绿 → 黄(本地) → 黄(云) → 绿
   - ✗ **本地处理错误**: 绿 → 黄 → 红
   - ✗ **云服务拒绝**: 绿 → 黄 → 黄(云) → 红
   - ✗ **网络错误**: 绿 → 黄 → 红

3. **详细的处理日志**
   - 时间戳显示
   - 按类型着色 (信息/成功/警告/错误)
   - 自动滚动到最新日志

4. **状态转换历史**
   - 记录每次状态改变的时间
   - 显示状态名称和额外信息
   - 完整的转换追踪

### 使用方式

```bash
# 1. 在浏览器中打开演示页面
open diagnostic-demo.html
# 或通过 Web 服务器访问
http://localhost:8080/diagnostic-demo.html

# 2. 点击四个测试场景按钮之一
# - 观看 LED 指示灯的状态转换
# - 查看详细的处理日志
# - 记录状态转换历史

# 3. 使用"重置指示灯"和"清除日志"按钮重新开始
```

---

## 集成到现有系统

### 在 dashboard.html 中添加按钮

```html
<!-- 在检测面板中添加错误测试按钮 -->
<button onclick="dashboardManager.startDetectionErrorTest('cloud_rejection')">
    <i class="fas fa-flask"></i> 演示红色告警
</button>

<!-- 支持不同的错误类型 -->
<button onclick="dashboardManager.startDetectionErrorTest('service_error')">
    演示服务错误
</button>
```

### 在现有检测流程中使用

前端和后端的所有修改都**完全向后兼容**，现有的检测流程无需任何修改就能获得新的功能：

```javascript
// 现有代码继续工作，同时获得新的功能
this.startDetection('auto');  // 自动模式
this.startDetection('example');  // 示例模式

// 新的错误测试模式
this.startDetectionErrorTest('cloud_rejection');
```

---

## 日志详解

### 正常完成的完整日志示例

```
[14:32:45] 指示灯已切换为: 绿色(正常) - 准备开始检测...
[14:32:46] 检测模式: 自动模式(实时数据)
[14:32:46] 目标节点: jet1
[14:32:46] 任务ID: a1b2c3d4
[14:32:46] 指示灯已切换为: 黄色(本地处理中) - 开始本地数据处理...
[14:32:47] 本地处理进度: 10%
[14:32:48] 本地处理进度: 25%
[14:32:49] 本地处理进度: 60%
[14:32:50] 检测到云处理请求: 低置信度样本=15
[14:32:50] 云端服务: 准备上传样本进行云端推理
[14:32:51] 指示灯已切换为: 黄色(云端处理中) - 云端处理中...
[14:32:52] 本地处理进度: 90%
[14:32:52] 云端上传: 15 个样本
[14:32:55] 云端处理耗时: 3500ms
[14:32:55] 指示灯已切换为: 绿色(完成) - 检测成功完成
[14:32:55] 统计信息: 总样本=100, 高置信=85, 低置信=15
[14:32:55] 本地推理耗时: 4870ms
```

### 云服务拒绝的完整日志示例

```
[14:33:10] 指示灯已切换为: 绿色(正常) - 准备开始检测...
[14:33:11] 检测模式: 自动模式(实时数据)
[14:33:11] 目标节点: jet1
[14:33:11] 任务ID: e5f6g7h8
[14:33:11] 指示灯已切换为: 黄色(本地处理中) - 开始本地数据处理...
[14:33:13] 检测到云处理请求: 低置信度样本=25
[14:33:13] 云端服务: 准备上传样本进行云端推理
[14:33:14] 指示灯已切换为: 黄色(云端处理中) - 云端处理中...
[14:33:15] 云端上传: 25 个样本
[14:33:18] 检测失败: 云服务拒绝处理: 低置信度样本数量超过阈值
[14:33:18] 错误详情: 云端AI服务评估认为样本质量不符合处理标准(平均置信度 < 0.7)
[14:33:18] 失败阶段: cloud_inference
[14:33:18] 指示灯已切换为: 红色(错误) - 检测失败: 云服务拒绝处理: 低置信度样本数量超过阈值
[14:33:18] 建议操作: 请重新采集更高质量的样本数据
```

---

## 技术亮点

### 1. 状态机设计
- 清晰的状态转换流程
- 完整的错误处理
- 自动的日志记录

### 2. 云处理特征识别
- 根据低置信度样本自动判断
- 记录云上传和处理耗时
- 支持多种错误类型

### 3. 实时反馈
- 指示灯颜色实时反映处理状态
- UE 灯光同步控制
- 详细的日志辅助调试

### 4. 演示和测试
- 独立的演示页面
- 支持各种错误场景
- 便于培训和演示

---

## 文件清单

| 文件 | 修改内容 |
|------|----------|
| `dashboard-manager.js` | 增强的状态管理、日志系统、错误测试功能 |
| `services/castray/main.py` | 云处理标志、错误测试 API 端点 |
| `diagnostic-demo.html` | 新建演示页面 |

---

## 向后兼容性

所有修改都**完全向后兼容**：

- ✅ 现有的 `setJetIndicators('red'/'yellow'/'green')` 调用继续工作
- ✅ 现有的检测 API 调用继续工作
- ✅ 新增功能完全可选，不影响现有流程
- ✅ API 响应格式扩展，老代码忽略新字段不出错

---

## 未来改进方向

1. **持久化日志存储** - 将日志存储到数据库以便后续分析
2. **性能指标收集** - 记录云处理的详细性能数据
3. **告警通知系统** - 当发生错误时发送邮件/短信通知
4. **自动重试机制** - 云处理失败时自动重试
5. **可视化仪表板** - 展示检测历史和错误统计

